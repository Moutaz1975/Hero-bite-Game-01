<!DOCTYPE html><html lang="ar" dir="rtl"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com https://script.google.com https://script.googleusercontent.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hero Bite Burger - لعبة بطل البرجر</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        heroGreen: '#2D8A3E',
                        heroYellow: '#F5D905',
                        heroRed: '#E53E3E',
                        legendary: '#FF6B35',
                        rare: '#9B59B6',
                        common: '#3498DB'
                    },
                    fontFamily: {
                        arabic: ['Tajawal', 'Arial', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;900&amp;display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Tajawal', Arial, sans-serif;
        }
        
        .game-canvas {
            border: 3px solid #2D8A3E;
            border-radius: 12px;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
            position: relative;
            overflow: hidden;
        }
        
        .hero-character {
            width: 60px;
            height: 60px;
            background-image: url('https://pfst.cf2.poecdn.net/base/image/11dc23dbfda38f7115386a40b84fc29837de67f7d6bdb1605cb93b8b9ce96332?w=212&h=273');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            transition: filter 0.2s ease;
        }
        
        .ingredient {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
        }
        
        .ingredient.common {
            background: linear-gradient(135deg, #3498DB, #5DADE2);
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
        }
        
        .ingredient.rare {
            background: linear-gradient(135deg, #9B59B6, #BB8FCE);
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.7);
            animation: rarePulse 2s infinite;
        }
        
        .ingredient.legendary {
            background: linear-gradient(135deg, #FF6B35, #FF8C69);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.9);
            animation: legendaryGlow 1.5s infinite;
        }
        
        @keyframes rarePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 15px rgba(155, 89, 182, 0.7); }
            50% { transform: scale(1.1); box-shadow: 0 0 25px rgba(155, 89, 182, 1); }
        }
        
        @keyframes legendaryGlow {
            0%, 100% { transform: scale(1) rotate(0deg); box-shadow: 0 0 20px rgba(255, 107, 53, 0.9); }
            50% { transform: scale(1.15) rotate(180deg); box-shadow: 0 0 30px rgba(255, 107, 53, 1); }
        }
        
        .points-popup {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
            z-index: 20;
            animation: pointsFloat 2s ease-out forwards;
        }
        
        @keyframes pointsFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }
        
        .combo-display {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #FF6B35, #FFD700);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
            z-index: 30;
            animation: comboAppear 0.5s ease-out;
        }
        
        @keyframes comboAppear {
            0% { transform: translateX(-50%) scale(0); }
            100% { transform: translateX(-50%) scale(1); }
        }
        
        .level-up-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 100;
            animation: levelUpAnimation 2s ease-out forwards;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
        }
        
        @keyframes levelUpAnimation {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 0; }
        }
        
        .xp-bar {
            background: linear-gradient(90deg, #3498DB, #2ECC71);
            height: 8px;
            border-radius: 4px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .xp-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
            animation: xpShine 2s infinite;
        }
        
        @keyframes xpShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .enemy {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: rgba(255, 0, 0, 0.2);
            animation: pulse 1s infinite;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .spin {
            animation: spin 3s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .bounce {
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .modal-overlay {
            backdrop-filter: blur(5px);
        }

        .sound-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #2D8A3E;
        }

        .sound-control:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        .instructions-btn {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #5D5CDE;
        }

        .instructions-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        .collect-effect {
            animation: collectPulse 0.3s ease-out;
        }

        @keyframes collectPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .damage-effect {
            animation: damageShake 0.5s ease-out;
        }

        @keyframes damageShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .leaderboard-current {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background: white;
            dark:bg-gray-800;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .multiplier-display {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #E74C3C, #FF6B35);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            z-index: 25;
            animation: multiplierPulse 1s infinite;
        }

        @keyframes multiplierPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }

        .connection-status {
            position: fixed;
            top: 140px;
            right: 20px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .connected {
            background: linear-gradient(135deg, #2ECC71, #27AE60);
            color: white;
        }

        .disconnected {
            background: linear-gradient(135deg, #E74C3C, #C0392B);
            color: white;
        }

        .disabled {
            background: linear-gradient(135deg, #F39C12, #E67E22);
            color: white;
        }

        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .setup-notice {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #3498DB, #2980B9);
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .game-paused {
            filter: blur(2px);
            opacity: 0.7;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-300">
    <!-- Google Sheets Setup Notice -->
    <div id="setupNotice" class="setup-notice hidden">
        📊 يرجى ربط Google Sheets لحفظ البيانات. راجع تعليمات المطور.
        <button onclick="document.getElementById('setupNotice').classList.add('hidden')" class="float-right text-lg">×</button>
    </div>

    <!-- Sound Control Button -->
    <div id="soundControl" class="sound-control" onclick="toggleSound()">
        <span id="soundIcon">🔊</span>
    </div>

    <!-- Instructions Button -->
    <div id="instructionsBtn" class="instructions-btn" onclick="showInstructions()">
        <span>📖</span>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="connection-status disconnected">
        📡 غير متصل
    </div>

    <!-- Welcome Screen -->
    <div id="welcomeScreen" class="fixed inset-0 bg-gradient-to-br from-heroYellow to-heroGreen flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 fade-in">
            <div class="text-center mb-6">
                <img src="https://pfst.cf2.poecdn.net/base/image/1d4911beae616d07605221da483bbf02c55b7beee8d518b6f7756f978b94b5d3?w=1000&amp;h=1000" alt="Hero Bite Burger" class="w-32 h-32 mx-auto mb-4 rounded-full shadow-lg">
                <h1 class="text-2xl font-bold text-heroGreen mb-2">مرحباً ببطل البرجر!</h1>
                <p class="text-gray-600 dark:text-gray-300 text-sm">اجمع المكونات الصحية واصنع 3 ساندويتشات للحصول على خصومات حقيقية!</p>
            </div>
            
            <form id="playerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">الاسم (اختياري)</label>
                    <input type="text" id="playerName" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="محمد">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">أدخل رقم التعبئة: <span class="text-red-500">*</span></label>
                    <input type="tel" id="playerPhone" required="" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="91234567" pattern="[0-9]{8}" maxlength="8">
                    <p class="text-xs text-gray-500 mt-1">8 أرقام فقط (رقم عُماني)</p>
                </div>
                
                <div id="dailyCodeWarning" class="hidden bg-yellow-100 dark:bg-yellow-900 border border-yellow-400 dark:border-yellow-600 text-yellow-700 dark:text-yellow-300 px-4 py-3 rounded-lg text-sm">
                    ⚠️ تم إنشاء كود خصم لهذا الرقم اليوم. سيتم استبدال الكود السابق إذا أكملت 3 برجرز.
                </div>
                
                <!-- Game Mode Buttons -->
                <div class="space-y-3 mt-6">
                    <button type="button" onclick="selectGameMode('story')" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">📖</span>
                        وضع القصة (4 مراحل)
                    </button>
                    
                    <button type="button" onclick="selectGameMode('survival')" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">⚔️</span>
                        وضع البقاء (لا نهائي)
                    </button>
                    
                    <button type="button" onclick="selectGameMode('timeAttack')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        <span class="mr-2">⏱️</span>
                        وضع السرعة (60 ثانية)
                    </button>
                </div>
            </form>
            
            <div class="mt-6 text-center text-xs text-gray-500">
                <p>📍 سلطنة عُمان | 📞 +968 9221 2012</p>
                <p>📱 @hero.bite</p>
                <button onclick="showInstructions()" class="mt-2 text-blue-500 hover:text-blue-700 underline">
                    📖 اقرأ التعليمات
                </button>
            </div>
        </div>
    </div>

    <!-- Game Instructions Modal -->
    <div id="instructionsModal" class="hidden fixed inset-0 modal-overlay bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-lg w-full mx-4 slide-up">
            <div class="p-6 max-h-screen overflow-y-auto">
                <h3 class="text-2xl font-bold text-heroGreen mb-4 text-center">📖 تعليمات اللعبة</h3>
                
                <div class="space-y-4 text-sm">
                    <div class="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 flex items-center">
                            <span class="mr-2">🎯</span>
                            الهدف
                        </h4>
                        <p>اجمع المكونات الصحية لصنع 3 برجرز واحصل على خصومات حقيقية!</p>
                    </div>
                    
                    <div class="bg-green-50 dark:bg-green-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 flex items-center">
                            <span class="mr-2">🎮</span>
                            التحكم
                        </h4>
                        <ul class="space-y-1">
                            <li>🖥️ الكمبيوتر: استخدم الأسهم أو A/D للحركة</li>
                            <li>📱 الجوال: استخدم الأزرار أو اسحب على الشاشة</li>
                            <li>⏸️ الإيقاف المؤقت: اضغط زر الإيقاف</li>
                        </ul>
                    </div>
                    
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 flex items-center">
                            <span class="mr-2">🥗</span>
                            المكونات والنقاط
                        </h4>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="flex justify-between">
                                <span>🥬 خس</span>
                                <span class="font-bold text-blue-600">5 نقاط</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🍅 طماطم</span>
                                <span class="font-bold text-blue-600">8 نقاط</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🧀 جبن</span>
                                <span class="font-bold text-purple-600">12 نقطة</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🥩 لحم</span>
                                <span class="font-bold text-orange-600">20 نقطة</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-red-50 dark:bg-red-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 flex items-center">
                            <span class="mr-2">⚠️</span>
                            تجنب الأطعمة الضارة
                        </h4>
                        <p>ابتعد عن 🥤 المشروبات الغازية و 🍟 البطاطس المقلية و 🍿 الفشار - ستفقد حياة!</p>
                    </div>
                    
                    <div class="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 flex items-center">
                            <span class="mr-2">💫</span>
                            نظام الكومبو
                        </h4>
                        <ul class="space-y-1 text-xs">
                            <li>• اجمع المكونات بسرعة لزيادة الكومبو</li>
                            <li>• الكومبو يضاعف النقاط حتى x5</li>
                            <li>• لديك 3 ثوانٍ بين كل مكون</li>
                            <li>• خسارة حياة تعيد الكومبو للصفر</li>
                        </ul>
                    </div>
                    
                    <div class="bg-orange-50 dark:bg-orange-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-2 flex items-center">
                            <span class="mr-2">🎁</span>
                            المكافآت
                        </h4>
                        <ul class="space-y-1 text-xs">
                            <li>• كل برجر مكتمل = 50+ نقطة إضافية</li>
                            <li>• 3 برجرز = عجلة الحظ للخصومات</li>
                            <li>• خصومات حقيقية من 5% إلى 50%</li>
                            <li>• ترقية المستوى تزيد المكافآت</li>
                        </ul>
                    </div>
                </div>
                
                <button onclick="closeInstructions()" class="w-full mt-6 bg-heroGreen hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">
                    فهمت! 🚀
                </button>
            </div>
        </div>
    </div>

    <!-- Main Game Screen -->
    <div id="gameScreen" class="hidden min-h-screen bg-gradient-to-br from-blue-100 to-green-100 dark:from-gray-800 dark:to-gray-900">
        <!-- Header -->
        <header class="bg-white dark:bg-gray-800 shadow-lg p-4">
            <div class="max-w-4xl mx-auto">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-4 space-x-reverse">
                        <img src="https://pfst.cf2.poecdn.net/base/image/11dc23dbfda38f7115386a40b84fc29837de67f7d6bdb1605cb93b8b9ce96332?w=212&amp;h=273" alt="Hero" class="w-12 h-12 rounded-full">
                        <div>
                            <h2 id="playerNameDisplay" class="font-bold text-lg">البطل</h2>
                            <p class="text-sm text-gray-600 dark:text-gray-400">المستوى <span id="playerLevel">1</span> | المرحلة <span id="currentLevel">1</span></p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4 space-x-reverse text-sm">
                        <div class="text-center">
                            <div class="text-heroRed font-bold">❤️ <span id="lives">3</span></div>
                        </div>
                        <div class="text-center">
                            <div class="text-heroYellow font-bold">⭐ <span id="score">0</span></div>
                        </div>
                        <div class="text-center">
                            <div class="text-heroGreen font-bold">🍔 <span id="burgers">0</span>/3</div>
                        </div>
                    </div>
                </div>
                
                <!-- XP Bar -->
                <div class="mb-2">
                    <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400 mb-1">
                        <span>خبرة: <span id="currentXP">0</span> / <span id="nextLevelXP">100</span></span>
                        <span id="comboText" class="text-orange-500 font-bold hidden">كومبو: x<span id="comboMultiplier">1</span></span>
                    </div>
                    <div class="bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                        <div id="xpBar" class="xp-bar h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Game Mode Selection -->
        <div id="modeSelection" class="max-w-4xl mx-auto p-4">
            <h3 class="text-2xl font-bold text-center mb-6 text-heroGreen">اختر وضع اللعب</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <button onclick="startGame('story')" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                    <div class="text-4xl mb-3">📖</div>
                    <h4 class="font-bold text-lg mb-2">وضع القصة</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">4 مراحل مع زعماء نهائيين</p>
                </button>
                
                <button onclick="startGame('survival')" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                    <div class="text-4xl mb-3">⚔️</div>
                    <h4 class="font-bold text-lg mb-2">وضع البقاء</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">تحديات لا نهائية</p>
                </button>
                
                <button onclick="startGame('timeAttack')" class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                    <div class="text-4xl mb-3">⏱️</div>
                    <h4 class="font-bold text-lg mb-2">وضع السرعة</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">60 ثانية من التحدي</p>
                </button>
            </div>
            
            <!-- Enhanced Stats and Leaderboard -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <!-- Player Stats -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h4 class="font-bold mb-3 text-center flex items-center justify-center">
                        <span class="mr-2">📊</span>
                        إحصائياتك المفصلة
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span>المستوى:</span>
                            <span id="statsLevel" class="font-bold text-blue-500">1</span>
                        </div>
                        <div class="flex justify-between">
                            <span>إجمالي النقاط:</span>
                            <span id="totalPoints" class="font-bold text-yellow-500">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>إجمالي البرجرز:</span>
                            <span id="totalBurgers" class="font-bold text-green-500">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>أطول كومبو:</span>
                            <span id="bestCombo" class="font-bold text-orange-500">0</span>
                        </div>
                        <hr class="my-2 border-gray-300 dark:border-gray-600">
                        <div class="text-xs text-center text-gray-500 mb-2">المكونات المجمعة:</div>
                        <div class="grid grid-cols-2 gap-1 text-xs">
                            <div class="flex justify-between">
                                <span>🥬 خس:</span>
                                <span id="lettuceCount" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🍅 طماطم:</span>
                                <span id="tomatoCount" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🧀 جبن:</span>
                                <span id="cheeseCount" class="font-bold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span>🥩 لحم:</span>
                                <span id="meatCount" class="font-bold">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Leaderboard -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h4 class="font-bold mb-3 text-center flex items-center justify-center">
                        <span class="mr-2">🏆</span>
                        لوحة الصدارة
                    </h4>
                    <div id="leaderboard" class="space-y-1 text-sm">
                        <!-- Leaderboard will be populated by JavaScript -->
                    </div>
                    <button onclick="updateLeaderboard()" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white text-xs py-2 px-4 rounded">
                        🔄 تحديث الترتيب
                    </button>
                </div>
                
                <!-- Points System Info -->
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h4 class="font-bold mb-3 text-center flex items-center justify-center">
                        <span class="mr-2">💎</span>
                        نظام النقاط
                    </h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between items-center">
                            <span class="flex items-center">
                                <span class="w-4 h-4 bg-common rounded-full mr-2"></span>
                                🥬 خس
                            </span>
                            <span class="font-bold text-common">5 نقاط</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center">
                                <span class="w-4 h-4 bg-common rounded-full mr-2"></span>
                                🍅 طماطم
                            </span>
                            <span class="font-bold text-common">8 نقاط</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center">
                                <span class="w-4 h-4 bg-rare rounded-full mr-2"></span>
                                🧀 جبن
                            </span>
                            <span class="font-bold text-rare">12 نقطة</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="flex items-center">
                                <span class="w-4 h-4 bg-legendary rounded-full mr-2"></span>
                                🥩 لحم
                            </span>
                            <span class="font-bold text-legendary">20 نقطة</span>
                        </div>
                        <hr class="my-2 border-gray-300 dark:border-gray-600">
                        <div class="text-xs text-gray-500">
                            <p>💫 الكومبو يضاعف النقاط حتى x5</p>
                            <p>⭐ كل برجر مكتمل = 50 نقطة إضافية</p>
                            <p>🎯 المكونات النادرة تعطي خبرة أكثر</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Canvas Area -->
        <div id="gameArea" class="hidden max-w-4xl mx-auto p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                <!-- Game Timer (for Time Attack mode) -->
                <div id="gameTimer" class="hidden text-center mb-4">
                    <div class="text-2xl font-bold text-heroRed">
                        ⏱️ <span id="timeLeft">60</span> ثانية
                    </div>
                </div>
                
                <!-- Game Canvas -->
                <div id="gameCanvas" class="game-canvas relative mx-auto" style="width: 100%; max-width: 600px; height: 400px;">
                    <!-- Player -->
                    <div id="player" class="hero-character absolute" style="bottom: 20px; left: 50%; transform: translateX(-50%);"></div>
                    
                    <!-- Combo Display -->
                    <div id="comboDisplay" class="hidden combo-display">
                        كومبو: x<span id="comboDisplayMultiplier">1</span>
                    </div>
                    
                    <!-- Multiplier Display -->
                    <div id="multiplierDisplay" class="hidden multiplier-display">
                        x<span id="currentMultiplier">1</span>
                    </div>
                    
                    <!-- Ingredients and Enemies will be spawned here -->
                </div>
                
                <!-- Game Controls -->
                <div class="mt-4 text-center">
                    <div class="grid grid-cols-3 gap-2 max-w-xs mx-auto md:hidden">
                        <button id="moveLeft" class="bg-heroGreen hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">→</button>
                        <button onclick="pauseGame()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">⏸️</button>
                        <button id="moveRight" class="bg-heroGreen hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg">←</button>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-2 hidden md:block">
                        استخدم الأسهم أو A/D للحركة | مسافة للقفز
                    </p>
                </div>
                
                <!-- Enhanced Burger Progress -->
                <div class="mt-4 bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="font-bold mb-2 text-center">البرجر الحالي</h4>
                    <div id="currentBurger" class="flex justify-center items-center space-x-2 space-x-reverse">
                        <div class="text-3xl">🍞</div>
                        <div id="ingredient1" class="text-2xl opacity-30 transition-all duration-300">🥬</div>
                        <div id="ingredient2" class="text-2xl opacity-30 transition-all duration-300">🍅</div>
                        <div id="ingredient3" class="text-2xl opacity-30 transition-all duration-300">🧀</div>
                        <div id="ingredient4" class="text-2xl opacity-30 transition-all duration-300">🥩</div>
                        <div class="text-3xl">🍞</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Discount Code Modal -->
    <div id="discountModal" class="hidden fixed inset-0 modal-overlay bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 slide-up">
            <div class="p-6 text-center">
                <div class="text-6xl mb-4">🎉</div>
                <h3 class="text-2xl font-bold text-heroGreen mb-4">مبروك! حصلت على خصم</h3>
                
                <div class="bg-gradient-to-r from-heroYellow to-heroGreen p-4 rounded-lg mb-4 text-white">
                    <div class="text-3xl font-bold mb-2"><span id="discountPercent">10</span>%</div>
                    <div class="text-sm">كود الخصم</div>
                    <div id="discountCode" class="text-lg font-mono font-bold tracking-wider">HERO10_462951</div>
                </div>
                
                <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    <p>📅 الإصدار: <span id="codeDate"></span></p>
                    <p>⏰ صالح حتى: <span id="codeExpiry"></span></p>
                    <p id="syncStatus" class="mt-2 text-blue-600">
                        <span class="loading-spinner"></span>
                        جاري حفظ البيانات...
                    </p>
                </div>
                
                <div class="space-y-3">
                    <button onclick="shareToWhatsApp()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">
                        📱 استخدم عبر واتساب
                    </button>
                    <button onclick="copyCode()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg">
                        📋 نسخ الكود
                    </button>
                    <button onclick="closeDiscountModal()" class="w-full border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-bold py-3 px-6 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lucky Wheel Modal -->
    <div id="luckyWheelModal" class="hidden fixed inset-0 modal-overlay bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 slide-up">
            <div class="p-6 text-center">
                <h3 class="text-2xl font-bold text-heroGreen mb-4">عجلة الحظ</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-6">أكملت 3 برجرز! اضغط لتدوير العجلة</p>
                
                <div class="relative w-48 h-48 mx-auto mb-6">
                    <div id="wheel" class="w-full h-full rounded-full border-8 border-heroGreen bg-gradient-to-r from-heroYellow via-heroRed to-heroGreen spin-wheel cursor-pointer" onclick="spinWheel()">
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="text-4xl">🎯</div>
                        </div>
                    </div>
                    <div class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1 w-0 h-0 border-l-4 border-r-4 border-b-8 border-transparent border-b-heroRed"></div>
                </div>
                
                <button id="spinButton" onclick="spinWheel()" class="w-full bg-heroGreen hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg pulse-animation">
                    🎲 ادر العجلة!
                </button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="hidden fixed inset-0 modal-overlay bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl max-w-md w-full mx-4 slide-up">
            <div class="p-6 text-center">
                <div class="text-6xl mb-4">😢</div>
                <h3 class="text-2xl font-bold text-gray-700 dark:text-gray-300 mb-4">انتهت اللعبة</h3>
                
                <div class="space-y-2 mb-6 text-sm">
                    <div class="flex justify-between">
                        <span>النقاط النهائية:</span>
                        <span id="finalScore" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>البرجرز المكتملة:</span>
                        <span id="finalBurgers" class="font-bold">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>المستوى النهائي:</span>
                        <span id="finalPlayerLevel" class="font-bold">1</span>
                    </div>
                    <div class="flex justify-between">
                        <span>أفضل كومبو:</span>
                        <span id="finalBestCombo" class="font-bold">0</span>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <button onclick="restartGame()" class="w-full bg-heroGreen hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">
                        🔄 العب مرة أخرى
                    </button>
                    <button onclick="backToMenu()" class="w-full border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 font-bold py-3 px-6 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
                        🏠 القائمة الرئيسية
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // 🔥 Google Sheets Integration Configuration - UPDATE THIS!
        const GOOGLE_SHEETS_CONFIG = {
            WEB_APP_URL: 'https://script.google.com/macros/s/AKfycbxGGUggc0h1DA1wh-jUP-XEJ5-OtP3_iqdcumE4UwNtl0HSXfz3hsO0IW78Wacv2SiA/exec',
            ENABLED: true,
            SHEET_ID: '1rzWVkaLdOZQPOFw4BFCMHgieDN22F2KHgv1rV4czreg'
        };

        // Audio Context for sound effects
        let audioContext;
        let soundEnabled = true;

        // Initialize Audio Context
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                return true;
            } catch (e) {
                console.log('Web Audio API not supported');
                soundEnabled = false;
                return false;
            }
        }

        // Enhanced Game state with Google Sheets integration
        let gameState = {
            player: { 
                name: '', 
                phone: '', 
                x: 270, // Fixed initial position
                y: 360,
                level: 1,
                xp: 0,
                nextLevelXP: 100
            },
            score: 0,
            lives: 3,
            level: 1,
            burgers: 0,
            totalBurgers: 0,
            gameMode: '',
            isPlaying: false,
            isPaused: false,
            startTime: 0,
            currentBurgerIngredients: [false, false, false, false], // lettuce, tomato, cheese, meat
            ingredients: [],
            enemies: [],
            timeLeft: 60,
            gameTimer: null,
            spawnTimer: null,
            
            // Advanced scoring system
            combo: 0,
            multiplier: 1,
            maxMultiplier: 5,
            comboTimer: null,
            comboTimeLimit: 3000, // 3 seconds
            bestCombo: 0,
            lastCollectTime: 0,
            
            // Google Sheets integration
            lastCodeToday: null,
            dailyCodeUsed: false,
            sheetsConnected: false,
            
            // Detailed statistics
            stats: {
                totalPoints: 0,
                lettuceCollected: 0,
                tomatoCollected: 0,
                cheeseCollected: 0,
                meatCollected: 0,
                bestCombo: 0,
                gamesPlayed: 0,
                totalPlayTime: 0
            }
        };

        // 📊 Google Sheets Integration Functions
        async function testGoogleSheetsConnection() {
            if (!GOOGLE_SHEETS_CONFIG.ENABLED) {
                updateConnectionStatus('disabled', '⚠️ Google Sheets غير مُفعل');
                showSetupNotice();
                return false;
            }

            if (GOOGLE_SHEETS_CONFIG.WEB_APP_URL.includes('YOUR_DEPLOYMENT_ID_HERE')) {
                updateConnectionStatus('disabled', '⚠️ يحتاج إعداد رابط Web App');
                showSetupNotice();
                return false;
            }

            try {
                const response = await fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ action: 'test' })


                if (response.ok) {
                    const data = await response.text();
                    if (data.includes('success') || data.includes('OK')) {
                        gameState.sheetsConnected = true;
                        updateConnectionStatus('connected', '✅ متصل');
                        hideSetupNotice();
                        return true;
                    }
                }
                throw new Error('Invalid response: ' + response.status);
            } catch (error) {
                gameState.sheetsConnected = false;
                updateConnectionStatus('disconnected', '❌ فشل الاتصال');
                console.error('Google Sheets connection error:', error);
                return false;
            }
        }

        function updateConnectionStatus(status, text) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `connection-status ${status}`;
            statusEl.textContent = text;
        }

        function showSetupNotice() {
            document.getElementById('setupNotice').classList.remove('hidden');
        }

        function hideSetupNotice() {
            document.getElementById('setupNotice').classList.add('hidden');
        }

        async function checkDailyCodeUsage(phone) {
            if (!gameState.sheetsConnected) {
                console.log('Sheets not connected, skipping daily check');
                return false;
            }

            try {
                const response = await fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=checkDaily&phone=${encodeURIComponent(phone)}`
                });

                if (response.ok) {
                    const data = await response.text();
                    const result = JSON.parse(data);
                    
                    if (result.hasCodeToday) {
                        gameState.dailyCodeUsed = true;
                        gameState.lastCodeToday = result.lastCode;
                        showDailyCodeWarning();
                        return true;
                    }
                }
            } catch (error) {
                console.error('Error checking daily code usage:', error);
            }
            return false;
        }

        function showDailyCodeWarning() {
            document.getElementById('dailyCodeWarning').classList.remove('hidden');
        }

        async function sendGameDataToSheets(data) {
            if (!gameState.sheetsConnected) {
                console.log('Sheets not connected, saving locally only');
                return false;
            }

            try {
                const payload = {
                    action: 'addGameData',
                    playerName: data.playerName,
                    phoneNumber: data.phoneNumber,
                    finalScore: data.finalScore,
                    burgersCompleted: data.burgersCompleted,
                    playerLevel: data.playerLevel,
                    gameMode: data.gameMode,
                    playTime: data.playTime,
                    ingredientsCollected: JSON.stringify(data.ingredientsCollected),
                    bestCombo: data.bestCombo,
                    timestamp: new Date().toISOString()
                };

                const formData = new URLSearchParams();
                Object.keys(payload).forEach(key => {
                    formData.append(key, payload[key]);
                });

                const response = await fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });

                if (response.ok) {
                    const result = await response.text();
                    console.log('✅ Game data saved to sheets:', result);
                    return true;
                } else {
                    throw new Error('HTTP ' + response.status);
                }
            } catch (error) {
                console.error('❌ Error sending game data to sheets:', error);
            }
            return false;
        }

        async function sendDiscountCodeToSheets(codeData) {
            if (!gameState.sheetsConnected) {
                console.log('Sheets not connected, saving discount code locally only');
                updateSyncStatus('warning', '⚠️ تم الحفظ محلياً فقط - لا يوجد اتصال بالخادم');
                return false;
            }

            try {
                const payload = {
                    action: 'addDiscountCode',
                    playerName: codeData.playerName,
                    phoneNumber: codeData.phoneNumber,
                    discountCode: codeData.discountCode,
                    discountPercent: codeData.discountPercent,
                    issuedDate: codeData.issuedDate,
                    expiryDate: codeData.expiryDate,
                    finalScore: codeData.finalScore,
                    playerLevel: codeData.playerLevel,
                    timestamp: new Date().toISOString()
                };

                const formData = new URLSearchParams();
                Object.keys(payload).forEach(key => {
                    formData.append(key, payload[key]);
                });

                const response = await fetch(GOOGLE_SHEETS_CONFIG.WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData.toString()
                });

                if (response.ok) {
                    const result = await response.text();
                    console.log('✅ Discount code saved to sheets:', result);
                    updateSyncStatus('success', '✅ تم حفظ الكود بنجاح!');
                    return true;
                } else {
                    throw new Error('HTTP ' + response.status + ': ' + await response.text());
                }
            } catch (error) {
                console.error('❌ Error sending discount code to sheets:', error);
                updateSyncStatus('error', '❌ خطأ في الحفظ - تم الحفظ محلياً فقط');
                return false;
            }
        }

        function updateSyncStatus(status, message) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                if (status === 'success') {
                    syncStatus.innerHTML = message;
                    syncStatus.className = 'mt-2 text-green-600';
                } else if (status === 'error') {
                    syncStatus.innerHTML = message;
                    syncStatus.className = 'mt-2 text-red-600';
                } else if (status === 'warning') {
                    syncStatus.innerHTML = message;
                    syncStatus.className = 'mt-2 text-yellow-600';
                } else {
                    syncStatus.innerHTML = `<span class="loading-spinner"></span>${message}`;
                    syncStatus.className = 'mt-2 text-blue-600';
                }
            }
        }

        // Game pause functionality
        function pauseGame() {
            gameState.isPaused = !gameState.isPaused;
            const gameCanvas = document.getElementById('gameCanvas');
            if (gameState.isPaused) {
                gameCanvas.classList.add('game-paused');
            } else {
                gameCanvas.classList.remove('game-paused');
            }
        }

        function pauseGameForModal() {
            if (gameState.isPlaying) {
                gameState.isPaused = true;
                const gameCanvas = document.getElementById('gameCanvas');
                gameCanvas.classList.add('game-paused');
            }
        }

        function resumeGameFromModal() {
            if (gameState.isPlaying) {
                gameState.isPaused = false;
                const gameCanvas = document.getElementById('gameCanvas');
                gameCanvas.classList.remove('game-paused');
            }
        }

        // Instructions modal functions
        function showInstructions() {
            document.getElementById('instructionsModal').classList.remove('hidden');
        }

        function closeInstructions() {
            document.getElementById('instructionsModal').classList.add('hidden');
        }

        // Enhanced Sound generation functions
        function playCollectSound(rarity = 'common') {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            let freq, duration, gain;
            switch(rarity) {
                case 'legendary':
                    freq = 1200;
                    duration = 0.4;
                    gain = 0.4;
                    break;
                case 'rare':
                    freq = 1000;
                    duration = 0.3;
                    gain = 0.35;
                    break;
                default:
                    freq = 800;
                    duration = 0.2;
                    gain = 0.3;
            }
            
            oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(freq * 1.5, audioContext.currentTime + duration);
            
            gainNode.gain.setValueAtTime(gain, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.type = 'sine';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playComboSound(multiplier) {
            if (!soundEnabled || !audioContext) return;
            
            // Play ascending notes based on multiplier
            const baseFreq = 400;
            for (let i = 0; i < Math.min(multiplier, 5); i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(baseFreq + (i * 100), audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.type = 'triangle';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                }, i * 50);
            }
        }

        function playLevelUpSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Play triumphant level up sound
            const melody = [
                {freq: 523.25, time: 0}, // C5
                {freq: 659.25, time: 0.15}, // E5
                {freq: 783.99, time: 0.3}, // G5
                {freq: 1046.50, time: 0.45}, // C6
                {freq: 1318.51, time: 0.6}, // E6
            ];
            
            melody.forEach((note) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.type = 'sine';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, note.time * 1000);
            });
        }

        function playHitSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
            
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.type = 'sawtooth';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        function playBurgerCompleteSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Play a happy melody
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.type = 'sine';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                }, index * 100);
            });
        }

        function playWheelSpinSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(100, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(500, audioContext.currentTime + 2);
            oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 3);
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime + 2.5);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 3);
            
            oscillator.type = 'square';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 3);
        }

        function playWinSound() {
            if (!soundEnabled || !audioContext) return;
            
            // Victory fanfare
            const melody = [
                {freq: 523.25, time: 0}, // C5
                {freq: 659.25, time: 0.2}, // E5
                {freq: 783.99, time: 0.4}, // G5
                {freq: 1046.50, time: 0.6}, // C6
                {freq: 783.99, time: 0.8}, // G5
                {freq: 1046.50, time: 1.0}, // C6
            ];
            
            melody.forEach((note) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(note.freq, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                    
                    oscillator.type = 'sine';
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.4);
                }, note.time * 1000);
            });
        }

        function playGameStartSound() {
            if (!soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.5);
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.type = 'triangle';
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            const soundIcon = document.getElementById('soundIcon');
            soundIcon.textContent = soundEnabled ? '🔊' : '🔇';
            
            // Store preference
            localStorage.setItem('soundEnabled', soundEnabled.toString());
        }

        // Ingredient system with rarity and points
        const ingredientSystem = {
            '🥬': { points: 5, rarity: 'common', xp: 2, spawnRate: 0.4 },
            '🍅': { points: 8, rarity: 'common', xp: 3, spawnRate: 0.35 },
            '🧀': { points: 12, rarity: 'rare', xp: 5, spawnRate: 0.2 },
            '🥩': { points: 20, rarity: 'legendary', xp: 8, spawnRate: 0.05 }
        };

        // Experience and level system
        function calculateXPForLevel(level) {
            return Math.floor(100 * Math.pow(1.2, level - 1));
        }

        function gainXP(amount) {
            gameState.player.xp += amount;
            
            while (gameState.player.xp >= gameState.player.nextLevelXP) {
                levelUp();
            }
            
            updateXPBar();
        }

        function levelUp() {
            gameState.player.xp -= gameState.player.nextLevelXP;
            gameState.player.level++;
            gameState.player.nextLevelXP = calculateXPForLevel(gameState.player.level);
            
            // Show level up effect
            showLevelUpEffect();
            playLevelUpSound();
            
            // Level up bonus
            gameState.score += gameState.player.level * 25;
            
            updateUI();
            savePlayerData();
        }

        function showLevelUpEffect() {
            const effect = document.createElement('div');
            effect.className = 'level-up-effect';
            effect.innerHTML = `🌟 ترقية! المستوى ${gameState.player.level} 🌟`;
            document.body.appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 2000);
        }

        function updateXPBar() {
            const percentage = (gameState.player.xp / gameState.player.nextLevelXP) * 100;
            document.getElementById('xpBar').style.width = percentage + '%';
            document.getElementById('currentXP').textContent = gameState.player.xp;
            document.getElementById('nextLevelXP').textContent = gameState.player.nextLevelXP;
            document.getElementById('playerLevel').textContent = gameState.player.level;
            document.getElementById('statsLevel').textContent = gameState.player.level;
        }

        // Combo and multiplier system
        function updateCombo() {
            gameState.combo++;
            
            // Update multiplier based on combo
            const newMultiplier = Math.min(Math.floor(gameState.combo / 3) + 1, gameState.maxMultiplier);
            if (newMultiplier > gameState.multiplier) {
                gameState.multiplier = newMultiplier;
                showMultiplierEffect();
                playComboSound(gameState.multiplier);
            }
            
            // Update best combo
            if (gameState.combo > gameState.bestCombo) {
                gameState.bestCombo = gameState.combo;
                gameState.stats.bestCombo = gameState.bestCombo;
            }
            
            updateComboDisplay();
            resetComboTimer();
        }

        function resetCombo() {
            gameState.combo = 0;
            gameState.multiplier = 1;
            updateComboDisplay();
            clearTimeout(gameState.comboTimer);
        }

        function resetComboTimer() {
            clearTimeout(gameState.comboTimer);
            gameState.comboTimer = setTimeout(() => {
                resetCombo();
            }, gameState.comboTimeLimit);
        }

        function updateComboDisplay() {
            const comboText = document.getElementById('comboText');
            const comboDisplay = document.getElementById('comboDisplay');
            const multiplierDisplay = document.getElementById('multiplierDisplay');
            
            if (gameState.combo > 0) {
                comboText.classList.remove('hidden');
                comboDisplay.classList.remove('hidden');
                multiplierDisplay.classList.remove('hidden');
                
                document.getElementById('comboMultiplier').textContent = gameState.multiplier;
                document.getElementById('comboDisplayMultiplier').textContent = gameState.multiplier;
                document.getElementById('currentMultiplier').textContent = gameState.multiplier;
            } else {
                comboText.classList.add('hidden');
                comboDisplay.classList.add('hidden');
                multiplierDisplay.classList.add('hidden');
            }
        }

        function showMultiplierEffect() {
            const display = document.getElementById('multiplierDisplay');
            display.classList.add('bounce');
            setTimeout(() => {
                display.classList.remove('bounce');
            }, 500);
        }

        // Enhanced points display
        function showPointsPopup(points, x, y, rarity = 'common') {
            const popup = document.createElement('div');
            popup.className = 'points-popup';
            popup.textContent = `+${points}`;
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            
            // Color based on rarity
            switch(rarity) {
                case 'legendary':
                    popup.style.color = '#FF6B35';
                    popup.style.fontSize = '22px';
                    break;
                case 'rare':
                    popup.style.color = '#9B59B6';
                    popup.style.fontSize = '20px';
                    break;
                default:
                    popup.style.color = '#3498DB';
                    popup.style.fontSize = '18px';
            }
            
            document.getElementById('gameCanvas').appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        // Leaderboard system
        function updateLeaderboard() {
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            const leaderboardEl = document.getElementById('leaderboard');
            
            // Sort by score descending
            leaderboard.sort((a, b) => b.score - a.score);
            
            leaderboardEl.innerHTML = '';
            
            leaderboard.slice(0, 10).forEach((player, index) => {
                const entry = document.createElement('div');
                const isCurrentPlayer = player.phone === gameState.player.phone;
                
                entry.className = `flex justify-between items-center p-2 rounded ${
                    isCurrentPlayer ? 'leaderboard-current' : 'hover:bg-gray-100 dark:hover:bg-gray-700'
                }`;
                
                const rank = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                
                entry.innerHTML = `
                    <div class="flex items-center space-x-2 space-x-reverse">
                        <span class="text-lg">${rank}</span>
                        <div>
                            <div class="font-bold text-sm">${player.name}</div>
                            <div class="text-xs opacity-75">المستوى ${player.level || 1}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold">${player.score}</div>
                        <div class="text-xs opacity-75">${player.burgers || 0} 🍔</div>
                    </div>
                `;
                
                leaderboardEl.appendChild(entry);
            });
            
            if (leaderboard.length === 0) {
                leaderboardEl.innerHTML = '<div class="text-center text-gray-500 text-sm">لا توجد نتائج بعد</div>';
            }
        }

        function addToLeaderboard(playerData) {
            const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
            
            // Check if player already exists
            const existingIndex = leaderboard.findIndex(p => p.phone === playerData.phone);
            
            if (existingIndex !== -1) {
                // Update if new score is better
                if (playerData.score > leaderboard[existingIndex].score) {
                    leaderboard[existingIndex] = playerData;
                }
            } else {
                leaderboard.push(playerData);
            }
            
            // Keep only top 20 players
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard.splice(20);
            
            localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
            updateLeaderboard();
        }

        // Player data persistence
        function savePlayerData() {
            const playerData = {
                name: gameState.player.name,
                phone: gameState.player.phone,
                level: gameState.player.level,
                xp: gameState.player.xp,
                nextLevelXP: gameState.player.nextLevelXP,
                totalBurgers: gameState.totalBurgers,
                stats: gameState.stats
            };
            localStorage.setItem('playerData', JSON.stringify(playerData));
            
            // Update stats display
            updateStatsDisplay();
        }

        function loadPlayerData() {
            const saved = localStorage.getItem('playerData');
            if (saved) {
                const data = JSON.parse(saved);
                gameState.player.level = data.level || 1;
                gameState.player.xp = data.xp || 0;
                gameState.player.nextLevelXP = data.nextLevelXP || calculateXPForLevel(gameState.player.level);
                gameState.totalBurgers = data.totalBurgers || 0;
                gameState.stats = { ...gameState.stats, ...data.stats };
                gameState.bestCombo = gameState.stats.bestCombo || 0;
            }

            // Load sound preference
            const savedSoundPref = localStorage.getItem('soundEnabled');
            if (savedSoundPref !== null) {
                soundEnabled = savedSoundPref === 'true';
                document.getElementById('soundIcon').textContent = soundEnabled ? '🔊' : '🔇';
            }
            
            updateStatsDisplay();
            updateXPBar();
            updateLeaderboard();
        }

        function updateStatsDisplay() {
            document.getElementById('totalPoints').textContent = gameState.stats.totalPoints;
            document.getElementById('totalBurgers').textContent = gameState.totalBurgers;
            document.getElementById('bestCombo').textContent = gameState.stats.bestCombo;
            document.getElementById('lettuceCount').textContent = gameState.stats.lettuceCollected;
            document.getElementById('tomatoCount').textContent = gameState.stats.tomatoCollected;
            document.getElementById('cheeseCount').textContent = gameState.stats.cheeseCollected;
            document.getElementById('meatCount').textContent = gameState.stats.meatCollected;
        }

        // Game mode selection from welcome screen
        let selectedMode = '';
        
        async function selectGameMode(mode) {
            const name = document.getElementById('playerName').value.trim() || 'البطل';
            const phone = document.getElementById('playerPhone').value.trim();
            
            if (!phone) {
                showCustomAlert('يرجى إدخال رقم التعبئة أولاً');
                return;
            }
            
            // Enhanced phone validation for Oman
            const phoneRegex = /^[0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                showCustomAlert('يرجى إدخال رقم تعبئة صحيح (8 أرقام فقط - رقم عُماني)');
                return;
            }
            
            // Validate Omani mobile prefixes (basic check)
            const validPrefixes = ['9', '7', '6'];
            if (!validPrefixes.includes(phone[0])) {
                showCustomAlert('يرجى إدخال رقم عُماني صحيح (يبدأ بـ 9، 7، أو 6)');
                return;
            }
            
            selectedMode = mode;
            gameState.player.name = name;
            gameState.player.phone = phone;
            gameState.startTime = Date.now();
            
            // Check daily code usage
            await checkDailyCodeUsage(phone);
            
            document.getElementById('playerNameDisplay').textContent = name;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // Initialize audio
            initAudio();
            playGameStartSound();
            
            loadPlayerData();
            
            // Start the selected game mode directly
            setTimeout(() => {
                startGame(selectedMode);
            }, 500);
        }

        // Welcome form handling (backup)
        document.getElementById('playerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('playerName').value.trim() || 'البطل';
            const phone = document.getElementById('playerPhone').value.trim();
            
            if (!phone) {
                showCustomAlert('يرجى إدخال رقم التعبئة');
                return;
            }
            
            // Enhanced phone validation for Oman
            const phoneRegex = /^[0-9]{8}$/;
            if (!phoneRegex.test(phone)) {
                showCustomAlert('يرجى إدخال رقم تعبئة صحيح (8 أرقام فقط - رقم عُماني)');
                return;
            }
            
            // Validate Omani mobile prefixes
            const validPrefixes = ['9', '7', '6'];
            if (!validPrefixes.includes(phone[0])) {
                showCustomAlert('يرجى إدخال رقم عُماني صحيح (يبدأ بـ 9، 7، أو 6)');
                return;
            }
            
            gameState.player.name = name;
            gameState.player.phone = phone;
            gameState.startTime = Date.now();
            
            document.getElementById('playerNameDisplay').textContent = name;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // Initialize audio
            initAudio();
            playGameStartSound();
            
            loadPlayerData();
        });

        // Custom alert function
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4 text-center">${message}</p>
                    <button class="w-full px-4 py-2 bg-primary text-white hover:bg-blue-600 rounded" onclick="this.closest('.fixed').remove()">حسناً</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Game functions
        function startGame(mode) {
            gameState.gameMode = mode;
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.lives = 3;
            gameState.level = 1;
            gameState.burgers = 0;
            gameState.currentBurgerIngredients = [false, false, false, false];
            gameState.ingredients = [];
            gameState.enemies = [];
            gameState.combo = 0;
            gameState.multiplier = 1;
            gameState.lastCollectTime = 0;
            gameState.isPaused = false;
            
            // Reset player position
            gameState.player.x = 270; // Center position
            const player = document.getElementById('player');
            player.style.left = gameState.player.x + 'px';
            
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('hidden');
            
            updateUI();
            updateComboDisplay();
            playGameStartSound();
            
            if (mode === 'timeAttack') {
                gameState.timeLeft = 60;
                document.getElementById('gameTimer').classList.remove('hidden');
                startTimer();
            }
            
            startGameLoop();
        }

        function startTimer() {
            gameState.gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timeLeft').textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function startGameLoop() {
            // Spawn ingredients and enemies
            gameState.spawnTimer = setInterval(() => {
                if (gameState.isPlaying && !gameState.isPaused) {
                    spawnIngredient();
                    if (Math.random() < 0.3) {
                        spawnEnemy();
                    }
                }
            }, 2000);
            
            // Game physics loop
            gameLoop();
        }

        function spawnIngredient() {
            // Weighted ingredient selection based on rarity
            const rand = Math.random();
            let ingredient = '🥬'; // default
            
            if (rand < ingredientSystem['🥩'].spawnRate) {
                ingredient = '🥩';
            } else if (rand < ingredientSystem['🥩'].spawnRate + ingredientSystem['🧀'].spawnRate) {
                ingredient = '🧀';
            } else if (rand < ingredientSystem['🥩'].spawnRate + ingredientSystem['🧀'].spawnRate + ingredientSystem['🍅'].spawnRate) {
                ingredient = '🍅';
            }
            
            const canvas = document.getElementById('gameCanvas');
            const canvasWidth = canvas.offsetWidth;
            const x = Math.random() * (canvasWidth - 35); // Account for ingredient width
            const system = ingredientSystem[ingredient];
            
            const ingredientEl = document.createElement('div');
            ingredientEl.className = `ingredient absolute ${system.rarity}`;
            ingredientEl.textContent = ingredient;
            ingredientEl.style.left = x + 'px';
            ingredientEl.style.top = '0px';
            ingredientEl.dataset.type = ingredient;
            
            canvas.appendChild(ingredientEl);
            gameState.ingredients.push({
                element: ingredientEl,
                x: x,
                y: 0,
                type: ingredient,
                rarity: system.rarity
            });
        }

        function spawnEnemy() {
            const enemies = ['🥤', '🍟', '🍿'];
            const enemy = enemies[Math.floor(Math.random() * enemies.length)];
            const canvas = document.getElementById('gameCanvas');
            const canvasWidth = canvas.offsetWidth;
            const x = Math.random() * (canvasWidth - 35); // Account for enemy width
            
            const enemyEl = document.createElement('div');
            enemyEl.className = 'enemy absolute';
            enemyEl.textContent = enemy;
            enemyEl.style.left = x + 'px';
            enemyEl.style.top = '0px';
            
            canvas.appendChild(enemyEl);
            gameState.enemies.push({
                element: enemyEl,
                x: x,
                y: 0
            });
        }

        function gameLoop() {
            if (!gameState.isPlaying) return;
            
            if (!gameState.isPaused) {
                // Move ingredients
                gameState.ingredients.forEach((ingredient, index) => {
                    ingredient.y += 2;
                    ingredient.element.style.top = ingredient.y + 'px';
                    
                    // Check collision with player
                    if (checkCollision(ingredient, gameState.player)) {
                        collectIngredient(ingredient.type, ingredient.x, ingredient.y, ingredient.rarity);
                        ingredient.element.remove();
                        gameState.ingredients.splice(index, 1);
                    }
                    
                    // Remove if off screen
                    if (ingredient.y > 400) {
                        ingredient.element.remove();
                        gameState.ingredients.splice(index, 1);
                    }
                });
                
                // Move enemies
                gameState.enemies.forEach((enemy, index) => {
                    enemy.y += 3;
                    enemy.element.style.top = enemy.y + 'px';
                    
                    // Check collision with player
                    if (checkCollision(enemy, gameState.player)) {
                        takeDamage();
                        enemy.element.remove();
                        gameState.enemies.splice(index, 1);
                    }
                    
                    // Remove if off screen
                    if (enemy.y > 400) {
                        enemy.element.remove();
                        gameState.enemies.splice(index, 1);
                    }
                });
            }
            
            requestAnimationFrame(gameLoop);
        }

        function checkCollision(obj1, obj2) {
            const tolerance = 30;
            return Math.abs(obj1.x - obj2.x) < tolerance && Math.abs(obj1.y - obj2.y) < tolerance;
        }

        function collectIngredient(type, x, y, rarity) {
            const ingredientMap = { '🥬': 0, '🍅': 1, '🧀': 2, '🥩': 3 };
            const index = ingredientMap[type];
            const system = ingredientSystem[type];
            
            if (index !== undefined && !gameState.currentBurgerIngredients[index]) {
                gameState.currentBurgerIngredients[index] = true;
                
                // Update combo
                updateCombo();
                
                // Calculate points with multiplier
                const basePoints = system.points;
                const finalPoints = basePoints * gameState.multiplier;
                gameState.score += finalPoints;
                gameState.stats.totalPoints += finalPoints;
                
                // Update ingredient statistics
                switch(type) {
                    case '🥬': gameState.stats.lettuceCollected++; break;
                    case '🍅': gameState.stats.tomatoCollected++; break;
                    case '🧀': gameState.stats.cheeseCollected++; break;
                    case '🥩': gameState.stats.meatCollected++; break;
                }
                
                // Gain XP
                gainXP(system.xp);
                
                // Play sound and show points
                playCollectSound(rarity);
                showPointsPopup(finalPoints, x, y, rarity);
                
                // Update burger display with animation
                const ingredientEl = document.getElementById(`ingredient${index + 1}`);
                ingredientEl.style.opacity = '1';
                ingredientEl.classList.add('collect-effect');
                
                setTimeout(() => {
                    ingredientEl.classList.remove('collect-effect');
                }, 300);
                
                // Check if burger is complete
                if (gameState.currentBurgerIngredients.every(Boolean)) {
                    completeBurger();
                }
                
                updateUI();
                updateStatsDisplay();
            }
        }

        function completeBurger() {
            gameState.burgers++;
            gameState.totalBurgers++;
            
            // Burger completion bonus with level multiplier
            const burgerBonus = 50 + (gameState.player.level * 10);
            gameState.score += burgerBonus;
            gameState.stats.totalPoints += burgerBonus;
            
            // XP bonus for completing burger
            gainXP(15 + gameState.player.level);
            
            gameState.currentBurgerIngredients = [false, false, false, false];
            
            // Play burger complete sound
            playBurgerCompleteSound();
            
            // Show completion effect
            showPointsPopup(burgerBonus, 300, 200, 'legendary');
            
            // Reset burger display
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`ingredient${i}`).style.opacity = '0.3';
                document.getElementById(`ingredient${i}`).classList.remove('collect-effect');
            }
            
            // Check for discount eligibility
            if (gameState.burgers >= 3) {
                showLuckyWheel();
                gameState.burgers = 0;
            }
            
            updateUI();
            updateStatsDisplay();
            savePlayerData();
        }

        function takeDamage() {
            gameState.lives--;
            
            // Reset combo on damage
            resetCombo();
            
            // Play hit sound
            playHitSound();
            
            if (gameState.lives <= 0) {
                endGame();
            } else {
                // Visual feedback for damage
                const player = document.getElementById('player');
                player.classList.add('damage-effect');
                player.style.filter = 'brightness(0.5)';
                
                setTimeout(() => {
                    player.style.filter = 'brightness(1)';
                    player.classList.remove('damage-effect');
                }, 500);
            }
            updateUI();
        }

        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('lives').textContent = gameState.lives;
            document.getElementById('burgers').textContent = gameState.burgers;
            document.getElementById('currentLevel').textContent = gameState.level;
            document.getElementById('playerLevel').textContent = gameState.player.level;
        }

        function showLuckyWheel() {
            pauseGameForModal();
            document.getElementById('luckyWheelModal').classList.remove('hidden');
        }

        function spinWheel() {
            const button = document.getElementById('spinButton');
            const wheel = document.getElementById('wheel');
            
            button.disabled = true;
            button.textContent = 'جاري التدوير...';
            
            // Play wheel spin sound
            playWheelSpinSound();
            
            // Add spinning animation
            wheel.style.animation = 'spin 3s ease-out';
            
            setTimeout(() => {
                const discounts = [
                    { percent: 5, weight: 35 },
                    { percent: 10, weight: 35 },
                    { percent: 12, weight: 12 },
                    { percent: 15, weight: 8 },
                    { percent: 20, weight: 5 },
                    { percent: 25, weight: 3 },
                    { percent: 30, weight: 1.5 },
                    { percent: 50, weight: 0.5 }
                ];
                
                const totalWeight = discounts.reduce((sum, d) => sum + d.weight, 0);
                const random = Math.random() * totalWeight;
                let currentWeight = 0;
                
                let selectedDiscount = discounts[0];
                for (const discount of discounts) {
                    currentWeight += discount.weight;
                    if (random <= currentWeight) {
                        selectedDiscount = discount;
                        break;
                    }
                }
                
                generateDiscountCode(selectedDiscount.percent);
                document.getElementById('luckyWheelModal').classList.add('hidden');
                wheel.style.animation = '';
                button.disabled = false;
                button.textContent = '🎲 ادر العجلة!';
                resumeGameFromModal();
            }, 3000);
        }

        async function generateDiscountCode(percent) {
            pauseGameForModal();
            
            const now = new Date();
            const expiry = new Date(now.getTime() + 48 * 60 * 60 * 1000); // 48 hours
            
            const codeNumber = Math.floor(Math.random() * 900000) + 100000;
            const code = `HERO${percent}_${codeNumber}`;
            
            document.getElementById('discountPercent').textContent = percent;
            document.getElementById('discountCode').textContent = code;
            document.getElementById('codeDate').textContent = now.toLocaleDateString('ar-SA');
            document.getElementById('codeExpiry').textContent = expiry.toLocaleDateString('ar-SA');
            
            // Store code locally
            const usedCodes = JSON.parse(localStorage.getItem('usedCodes') || '[]');
            const codeData = {
                code: code,
                phone: gameState.player.phone,
                playerName: gameState.player.name,
                percent: percent,
                date: now.toISOString(),
                expiry: expiry.toISOString(),
                finalScore: gameState.score,
                playerLevel: gameState.player.level
            };
            usedCodes.push(codeData);
            localStorage.setItem('usedCodes', JSON.stringify(usedCodes));
            
            // Play win sound
            playWinSound();
            
            document.getElementById('discountModal').classList.remove('hidden');
            
            // 📊 Send discount code to Google Sheets
            try {
                updateSyncStatus('syncing', 'جاري حفظ البيانات...');
                const success = await sendDiscountCodeToSheets({
                    playerName: gameState.player.name,
                    phoneNumber: gameState.player.phone,
                    discountCode: code,
                    discountPercent: percent,
                    issuedDate: now.toISOString(),
                    expiryDate: expiry.toISOString(),
                    finalScore: gameState.score,
                    playerLevel: gameState.player.level
                });
                
                if (!success && gameState.sheetsConnected) {
                    updateSyncStatus('error', '❌ لم يتم حفظ البيانات أونلاين، تم الحفظ محلياً فقط');
                }
            } catch (error) {
                console.error('Error saving discount code:', error);
                updateSyncStatus('error', '❌ خطأ في الحفظ');
            }
        }

        function shareToWhatsApp() {
            const code = document.getElementById('discountCode').textContent;
            const percent = document.getElementById('discountPercent').textContent;
            const message = `🎉 حصلت على خصم ${percent}% من Hero Bite Burger!\n\n📝 كود الخصم: ${code}\n📞 للطلب: +968 9221 2012\n📍 سلطنة عُمان\n\n#HeroBiteBurger`;
            
            const url = `https://wa.me/96892212012?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function copyCode() {
            const code = document.getElementById('discountCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showCustomAlert('تم نسخ الكود بنجاح! 📋');
            }).catch(() => {
                showCustomAlert('فشل في نسخ الكود. يرجى نسخه يدوياً.');
            });
        }

        function closeDiscountModal() {
            document.getElementById('discountModal').classList.add('hidden');
            resumeGameFromModal();
        }

        async function endGame() {
            gameState.isPlaying = false;
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            if (gameState.spawnTimer) clearInterval(gameState.spawnTimer);
            
            const playTime = gameState.startTime ? Date.now() - gameState.startTime : 0;
            
            // 📊 Prepare game data for Google Sheets
            const gameData = {
                playerName: gameState.player.name,
                phoneNumber: gameState.player.phone,
                finalScore: gameState.score,
                burgersCompleted: gameState.totalBurgers,
                playerLevel: gameState.player.level,
                gameMode: gameState.gameMode,
                playTime: playTime,
                ingredientsCollected: {
                    lettuce: gameState.stats.lettuceCollected,
                    tomato: gameState.stats.tomatoCollected,
                    cheese: gameState.stats.cheeseCollected,
                    meat: gameState.stats.meatCollected
                },
                bestCombo: gameState.bestCombo
            };
            
            // Send game data to Google Sheets
            try {
                await sendGameDataToSheets(gameData);
            } catch (error) {
                console.error('Error saving game data:', error);
            }
            
            // Add to leaderboard
            addToLeaderboard({
                name: gameState.player.name,
                phone: gameState.player.phone,
                score: gameState.score,
                level: gameState.player.level,
                burgers: gameState.totalBurgers,
                date: new Date().toISOString()
            });
            
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalBurgers').textContent = gameState.totalBurgers;
            document.getElementById('finalPlayerLevel').textContent = gameState.player.level;
            document.getElementById('finalBestCombo').textContent = gameState.bestCombo;
            
            document.getElementById('gameOverModal').classList.remove('hidden');
            savePlayerData();
        }

        function restartGame() {
            document.getElementById('gameOverModal').classList.add('hidden');
            
            // Clear canvas
            const canvas = document.getElementById('gameCanvas');
            const items = canvas.querySelectorAll('.ingredient, .enemy, .points-popup');
            items.forEach(item => item.remove());
            
            // Reset combo
            resetCombo();
            
            gameState.startTime = Date.now();
            startGame(gameState.gameMode);
        }

        function backToMenu() {
            document.getElementById('gameOverModal').classList.add('hidden');
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameTimer').classList.add('hidden');
            document.getElementById('modeSelection').classList.remove('hidden');
            
            // Clear canvas
            const canvas = document.getElementById('gameCanvas');
            const items = canvas.querySelectorAll('.ingredient, .enemy, .points-popup');
            items.forEach(item => item.remove());
            
            gameState.isPlaying = false;
            if (gameState.gameTimer) clearInterval(gameState.gameTimer);
            if (gameState.spawnTimer) clearInterval(gameState.spawnTimer);
            
            // Reset combo
            resetCombo();
        }

        // Player movement with fixed boundaries
        const keys = {};
        
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            handleMovement();
        });
        
        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        function handleMovement() {
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            const player = document.getElementById('player');
            const canvas = document.getElementById('gameCanvas');
            const canvasWidth = canvas.offsetWidth;
            const playerWidth = 60;
            
            const moveSpeed = 15;
            
            if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
                gameState.player.x -= moveSpeed;
                
                // Wraparound: إذا خرج من اليسار، يظهر من اليمين
                if (gameState.player.x < -playerWidth) {
                    gameState.player.x = canvasWidth;
                }
            }
            if (keys['ArrowRight'] || keys['d'] || keys['D']) {
                gameState.player.x += moveSpeed;
                
                // Wraparound: إذا خرج من اليمين، يظهر من اليسار
                if (gameState.player.x > canvasWidth) {
                    gameState.player.x = -playerWidth;
                }
            }
            
            player.style.left = gameState.player.x + 'px';
        }

        // Touch controls for mobile
        let touchStartX = 0;
        
        document.getElementById('moveLeft').addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys['ArrowLeft'] = true;
            const moveInterval = setInterval(() => {
                if (keys['ArrowLeft']) {
                    handleMovement();
                } else {
                    clearInterval(moveInterval);
                }
            }, 50);
        });
        
        document.getElementById('moveLeft').addEventListener('touchend', () => {
            keys['ArrowLeft'] = false;
        });
        
        document.getElementById('moveRight').addEventListener('touchstart', (e) => {
            e.preventDefault();
            keys['ArrowRight'] = true;
            const moveInterval = setInterval(() => {
                if (keys['ArrowRight']) {
                    handleMovement();
                } else {
                    clearInterval(moveInterval);
                }
            }, 50);
        });
        
        document.getElementById('moveRight').addEventListener('touchend', () => {
            keys['ArrowRight'] = false;
        });

        // Touch swipe controls
        document.getElementById('gameCanvas').addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });
        
        document.getElementById('gameCanvas').addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            const diff = touchX - touchStartX;
            
            if (Math.abs(diff) > 10) {
                if (diff > 0) {
                    keys['ArrowRight'] = true;
                    keys['ArrowLeft'] = false;
                } else {
                    keys['ArrowLeft'] = true;
                    keys['ArrowRight'] = false;
                }
                handleMovement();
            }
        });
        
        document.getElementById('gameCanvas').addEventListener('touchend', () => {
            keys['ArrowLeft'] = false;
            keys['ArrowRight'] = false;
        });

        // 🚀 Initialize game
        loadPlayerData();
        
        // Test Google Sheets connection on load
        setTimeout(() => {
            testGoogleSheetsConnection();
        }, 1500);
        
        // Initialize audio on first user interaction
        document.addEventListener('click', function initAudioOnInteraction() {
            if (!audioContext) {
                initAudio();
            }
            document.removeEventListener('click', initAudioOnInteraction);
        }, { once: true });
    </script>



</body></html>